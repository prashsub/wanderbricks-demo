---
description: Patterns for setting up Databricks Genie Spaces with comprehensive agent instructions, data assets, and benchmark questions
globs: docs/gold/*GENIE*.md
alwaysApply: false
---
# Databricks Genie Space Setup Patterns

## Pattern Recognition
When creating Genie Spaces for natural language analytics, follow a structured approach with comprehensive agent instructions, properly selected data assets, and validated benchmark questions. This rule standardizes Genie Space configuration for production deployments.

**Key Patterns:**
1. **Four-Section Structure**: Description → Agent Instructions → Data Assets → Benchmark Q&A
2. **Business Context First**: Agent needs deep domain knowledge before query patterns
3. **Data Asset Hierarchy**: Metric Views (primary) → TVFs (specific queries) → Tables (reference)
4. **Testing Framework**: Benchmark questions with expected answers and validation criteria

## Core Principle: Business Context Drives AI Quality

**The quality of Genie responses directly correlates with the depth of business context provided in agent instructions.**

---

## Section 1: Space Description Pattern

### Business Context Structure

```markdown
BUSINESS CONTEXT:
[Company/Partner] [relationship description]

Products: [Product categories with specific brands/SKUs]
Scope: [What data is tracked: transactions, inventory, operations]
Users: [Target user roles and their needs]

DATA COVERAGE:
• [Quantify scope: N stores, N SKUs, N transactions]
• [Data granularity: daily, hourly, real-time]
• [Key dimensions available]
• [Time range available]

AVAILABLE ANALYTICS:

1. [Domain 1 Name]
   • [Use case 1]
   • [Use case 2]
   • [Use case 3]

2. [Domain 2 Name]
   • [Use case 1]
   • [Use case 2]

USE CASES:
✓ [User role 1] [specific task]
✓ [User role 2] [specific task]
✓ [User role 3] [specific task]
```

### Example (Actual Implementation)

```markdown
BUSINESS CONTEXT:
Acme Corporation partners with RetailChain to distribute consumer products 
across multiple product categories.

DATA COVERAGE:
• 100+ RetailChain store locations across multiple states
• 50+ Acme product SKUs with UPC tracking
• Daily sales transactions with pricing and discounts
• Real-time inventory positions (on-hand, minimum, forecast)

AVAILABLE ANALYTICS:

1. Sales Performance
   • Daily/monthly/quarterly revenue analysis
   • Transaction volumes and average basket size
   • Promotional effectiveness (multi-unit, coupon, loyalty discounts)
```

---

## Section 2: Agent Instructions Pattern

### Critical Components (All Required)

```markdown
=================================================================================
[PROJECT NAME] - GENIE AGENT INSTRUCTIONS
=================================================================================

BUSINESS DOMAIN KNOWLEDGE:

1. [DOMAIN ENTITY 1]
   • [Key classification or concept]
   • [Identifiers used]
   • [Hierarchies or groupings]

2. [DOMAIN ENTITY 2]
   • [Types or categories]
   • [Business rules]

3. [TRANSACTION TYPES]
   • [Type 1]: [Description and business logic]
   • [Type 2]: [Description and business logic]

4. [PROGRAM/FEATURE 1]
   • [Component 1]: [Business definition]
   • [Component 2]: [Business definition]
   • [Metric]: [How calculated]

5. [DOMAIN CONCEPT]
   • [Classification 1]: [Definition and criteria]
   • [Classification 2]: [Definition and criteria]

6. [ANOTHER PROGRAM/FEATURE]
   • [Field 1]: [Description]
   • [Field 2]: [Description]
   • [Calculation]: [Formula]

7. KEY PERFORMANCE INDICATORS (KPIs)

   [Category 1] Metrics:
   • [Metric 1] = [Formula with clear variable definitions]
   • [Metric 2] = [Formula]
   
   [Category 2] Metrics:
   • [Metric 1] = [Formula]
   • [Metric 2] = [Formula]

8. TIME DIMENSIONS
   • [Hierarchy]: Year > Quarter > Month > Week > Day
   • [Fiscal periods description]
   • [Special time classifications]
   • Time Comparisons:
     - Week-over-Week (WoW)
     - Month-over-Month (MoM)
     - Quarter-over-Quarter (QoQ)
     - Year-over-Year (YoY)

9. GEOGRAPHIC ANALYSIS LEVELS
   • [Level 1]: [Description]
   • [Level 2]: [Description]
   • [Level 3]: [Description]

=================================================================================
DATA ASSETS AVAILABLE
=================================================================================

PRIMARY METRIC VIEWS (Use These First):

1. [metric_view_name]
   Purpose: [One-sentence description]
   Source: [Underlying fact table]
   Grain: [Aggregation level]
   Dimensions: [List key dimensions]
   Measures: [Count]+ measures including [examples]
   Window Measures: [List rolling windows, YoY]
   Best For: "[Example query pattern 1]", "[Example query pattern 2]"

TABLE-VALUED FUNCTIONS (Use for Specific Queries):

1. [function_name]([parameters])
   Returns: [Result description]
   Use When: [Specific scenario]
   Example: "[Natural language query example]"

=================================================================================
QUERY INTERPRETATION GUIDELINES
=================================================================================

1. TIME PERIOD HANDLING
   When user says:          Interpret as:
   • "this month"         → [SQL/filter logic]
   • "last month"         → [SQL/filter logic]
   • "this quarter"       → [SQL/filter logic]
   • "last 7 days"        → [SQL/filter logic or window measure]
   • "YTD"                → [SQL/filter logic]

2. AGGREGATION LEVEL DETECTION
   When user says:          Group by:
   • "by [dimension1]"   → [table.column]
   • "by [dimension2]"   → [table.column]
   • "by [dimension3]"   → [table.column]

3. RANKING AND LIMITS
   When user says:          Use:
   • "top 10"            → ORDER BY metric DESC LIMIT 10
   • "bottom 5"          → ORDER BY metric ASC LIMIT 5
   • "best performing"   → ORDER BY [primary_metric] DESC

4. COMPARISON KEYWORDS
   When user says:          Strategy:
   • "compare X vs Y"    → Use CASE WHEN or PIVOT
   • "growth"            → Calculate (current - prior) / prior * 100
   • "trend"             → ORDER BY date ASC
   • "vs last year"      → Join to prior year data

5. FILTER KEYWORDS
   When user says:          Filter:
   • "[brand/category1]" → [table.column] = '[value]'
   • "[classification1]" → [table.column] = [boolean/value]
   • "[status1]"         → [table.column] = '[value]'

6. METRIC SELECTION
   When user asks about:    Use measure:
   • "[term1]" / "[term2]" → [measure_name]
   • "[term3]" / "[term4]" → [measure_name]

7. AMBIGUITY RESOLUTION
   If user query is unclear:
   • Default to [most common metric] (not [alternative])
   • Default to [time period] if no time specified
   • Default to [scope] if no filter specified
   • Include [key identifiers] for clarity

8. HANDLING MISSING DATA
   • If metric view doesn't have requested data, check if TVF provides it
   • If neither works, query underlying gold tables
   • Always validate time period filters
   • If no data matches filters, return empty result with explanation

9. COMPLEX QUERIES
   For multi-part questions:
   • Break into subqueries
   • Use CTEs for readability
   • Combine metric views when crossing domains
   • Use window functions for ranking within groups

10. RESPONSE FORMAT
    Always include:
    • Clear column headers with business-friendly names
    • Proper formatting (currency, percentages, integers)
    • Sorted results (DESC for "top", ASC for "bottom")
    • Limited results (TOP N) for large datasets

=================================================================================
IMPORTANT CONSTRAINTS
=================================================================================

DATA QUALITY NOTES:
• [Layer] data has passed [validation process]
• [Special handling for edge cases]
• [Identification of special record types]

PERFORMANCE BEST PRACTICES:
• Use metric views instead of fact tables (pre-aggregated)
• Specify time period filters
• Use TOP N to limit result sets
• Leverage window_measures for rolling windows

BUSINESS RULES:
• [Rule 1 with formula]
• [Rule 2 with data type notes]
• [Rule 3 with SCD handling]

=================================================================================
EXAMPLE QUERY PATTERNS
=================================================================================

PATTERN 1: Top N with Time Filter
Question: "[Example natural language question]"
Strategy:
  FROM [metric_view]
  WHERE [time_filter]
  GROUP BY [dimension]
  ORDER BY MEASURE([metric]) DESC
  LIMIT N

[Include 4-5 more patterns covering different query types]

=================================================================================
TROUBLESHOOTING TIPS
=================================================================================

If query fails:
1. [Common issue 1 and fix]
2. [Common issue 2 and fix]
3. [Common issue 3 and fix]

If results seem wrong:
1. [Validation check 1]
2. [Validation check 2]
3. [Validation check 3]

=================================================================================
SYNONYMS AND ALIASES
=================================================================================

[Business Term 1]: [synonym1], [synonym2], [synonym3]
[Business Term 2]: [synonym1], [synonym2], [synonym3]

=================================================================================
END OF INSTRUCTIONS
=================================================================================
```

### Why This Structure?

| Section | Purpose | Impact on Genie Quality |
|---------|---------|------------------------|
| **Business Domain Knowledge** | Teaches Genie your business concepts | ⭐⭐⭐⭐⭐ Critical |
| **Data Assets Available** | Shows what data sources to use | ⭐⭐⭐⭐⭐ Critical |
| **Query Interpretation** | Maps natural language to SQL patterns | ⭐⭐⭐⭐⭐ Critical |
| **Constraints** | Prevents common errors | ⭐⭐⭐⭐ Very Important |
| **Example Patterns** | Provides concrete query templates | ⭐⭐⭐⭐ Very Important |
| **Troubleshooting** | Helps Genie recover from failures | ⭐⭐⭐ Important |
| **Synonyms** | Improves query understanding | ⭐⭐⭐ Important |

---

## Section 3: Data Assets Organization Pattern

### Hierarchy: Metric Views → TVFs → Tables

**Always add assets in this order:**

1. **Primary Metric Views** (Add first, use most)
   - Pre-aggregated for performance
   - Rich with measures and dimensions
   - Best for broad analytical queries

2. **Table-Valued Functions** (Add second, use for specific patterns)
   - Parameterized queries
   - Business logic encapsulation
   - Complex filtering or calculations

3. **Reference Tables** (Add last, use sparingly)
   - Direct table access
   - When metric views/TVFs insufficient
   - Performance considerations

### Metric View Documentation Pattern

```markdown
#### [Metric View Display Name]

**Fully Qualified Name:**
```
[catalog].[schema].[metric_view_name]
```

**Description for Genie:**
```
[One-sentence purpose]. [Pre-aggregation details].

DIMENSIONS AVAILABLE:
• [Domain 1]: [dim1], [dim2], [dim3] ([classification details])
• [Domain 2]: [dim1], [dim2], [dim3]
• [Domain 3]: [dim1], [dim2], [dim3]

MEASURES AVAILABLE ([N]+ metrics):
• [Category 1]: [measure1], [measure2], [measure3]
• [Category 2]: [measure1], [measure2], [measure3]
• [Category 3]: [measure1], [measure2], [measure3]

WINDOW MEASURES (Time Intelligence):
• Rolling [N]-day: [measure1]_last_[N]_days, [measure2]_last_[N]_days
• Rolling [N]-day: [measure1]_last_[N]_days
• Year-over-Year: [measure]_yoy, [measure]_yoy_growth

TYPICAL USE CASES:
✓ "[Example question 1]"
✓ "[Example question 2]"
✓ "[Example question 3]"
```

**Example Questions:**
```
• [Question 1]
• [Question 2]
• [Question 3]
• [Question 4]
• [Question 5]
```
```

### TVF Documentation Pattern

```markdown
#### [Function Display Name]

**Fully Qualified Name:**
```
[catalog].[schema].[function_name]
```

**Description:**
```
[Purpose statement].

PARAMETERS:
• [param1]: [Description and data type]
• [param2]: [Description and default value if applicable]

RETURNS:
• [col1], [col2], [col3], [col4]

USE WHEN:
[Scenario description], e.g., "[Example natural language query]"
```
```

---

## Section 4: Benchmark Questions Pattern

### Organization by Business Function

Create 20-30 benchmark questions organized by business domain:

```markdown
### **Category 1: [Business Function Name]**

#### Q1.1: [Question Topic]
**Business Question:**
```
[Natural language question as user would ask]
```

**Expected Genie Query Strategy:**
- Metric View: `[metric_view_name]`
- Filter: `[SQL conditions or description]`
- Group By: `[dimensions]`
- Measure: `[metric expression]`
- Sort: `[ORDER BY clause]`
- Limit: `[LIMIT clause if applicable]`

**Expected Answer Format:**
| [Column 1] | [Column 2] | [Column 3] | [Column 4] |
|------------|------------|------------|------------|
| [Example 1] | [Data] | [Data] | [Data] |
| [Example 2] | [Data] | [Data] | [Data] |

**Validation Criteria:**
✓ [Check 1]
✓ [Check 2]
✓ [Check 3]
```

### Question Categories by Complexity

**Simple (Single dimension, single metric):**
- "What are the top 10 [entities] by [metric]?"
- "Show me [metric] by [dimension]"

**Moderate (Multiple dimensions, time filters):**
- "Compare [metric] for [filter1] vs [filter2]"
- "Show [metric] by [dimension] for [time_period]"

**Advanced (Multi-metric, calculated fields, joins):**
- "Show [entities] with high [metric1] but low [metric2]"
- "Compare [metric1] and [metric2] across [dimension1] and [dimension2]"

**Complex (Cross-domain, window functions, multiple data sources):**
- "Show [metric] trend with [comparison] for [filtered_entities]"
- "Analyze [dimension1] by [dimension2] with [calculated_metric]"

### Minimum Coverage

Ensure benchmark questions cover:
- [ ] All primary metric views (at least 3 questions each)
- [ ] All TVFs (at least 1 question each)
- [ ] Common time periods (this month, last quarter, YTD, rolling windows)
- [ ] All major dimensions (geographic, product, time, customer segments)
- [ ] Key business calculations (growth %, rates, averages, rankings)
- [ ] Edge cases (missing data, zero values, negative values)
- [ ] Multi-dimensional analysis (2+ dimensions combined)

---

## Testing and Validation Pattern

### Test Execution Plan

```markdown
### Test Plan

After setting up the Genie Space, systematically test with benchmark questions:

1. **Category 1 ([Name])** - Test [N] questions, verify results
2. **Category 2 ([Name])** - Test [N] questions, verify results
[Continue for all categories]

### Success Criteria

For each question:
- [ ] Genie understands the question
- [ ] Correct metric view or TVF is used
- [ ] Filters are applied correctly
- [ ] Aggregation level is appropriate
- [ ] Results are formatted properly
- [ ] Query completes in < 10 seconds
- [ ] Answer matches expected format

### Common Issues and Fixes

| Issue | Solution |
|-------|----------|
| [Common issue 1] | [Fix or workaround] |
| [Common issue 2] | [Fix or workaround] |
| [Common issue 3] | [Fix or workaround] |
```

---

## User Training Pattern

### Quick Start Guide Structure

```markdown
### Quick Start Guide for Business Users

**Welcome to [Project Name] Analytics with Genie!**

**WHAT IS GENIE?**
[One-sentence explanation]

**HOW TO ACCESS:**
1. [Step 1]
2. [Step 2]
3. [Step 3]

**EXAMPLE QUESTIONS YOU CAN ASK:**

**[Domain 1]:**
- "[Question 1]"
- "[Question 2]"
- "[Question 3]"

**[Domain 2]:**
- "[Question 1]"
- "[Question 2]"

**TIPS FOR BETTER RESULTS:**
✓ [Tip 1]
✓ [Tip 2]
✓ [Tip 3]
✓ [Tip 4]

**NEED HELP?**
Contact: [Team name]
Email: [email]
Slack: [channel]
```

---

## Deployment Checklist Pattern

### Pre-Launch Validation

```markdown
## ✅ Deployment Checklist

Before launching to users:

### Configuration
- [ ] Genie Space created with descriptive name
- [ ] Space description added (Section 1)
- [ ] Agent instructions configured (Section 2)
- [ ] SQL Warehouse selected (Serverless recommended)

### Data Assets
- [ ] Metric view: [view1] added as trusted data
- [ ] Metric view: [view2] added as trusted data
- [ ] TVF: [function1] added
- [ ] TVF: [function2] added
[Continue for all assets]

### Testing
- [ ] All [N] benchmark questions tested
- [ ] Results validated against expected answers
- [ ] Query performance acceptable (< 10 sec)
- [ ] Error handling verified

### Permissions
- [ ] [Owner group] granted OWNER access
- [ ] [User group 1] granted CAN USE access
- [ ] [User group 2] granted CAN USE access
- [ ] All users have SELECT on metric views and TVFs

### Training
- [ ] User quick start guide distributed
- [ ] Example questions document shared
- [ ] Training session scheduled
- [ ] Support channel created

### Documentation
- [ ] Setup guide finalized
- [ ] Benchmark questions documented
- [ ] Troubleshooting guide created
- [ ] Contact information provided
```

---

## Maintenance Pattern

### Ongoing Tasks

```markdown
### Weekly Tasks
- Review query history in Genie Space
- Identify failed queries and improve instructions
- Add new example questions based on usage patterns

### Monthly Tasks
- Analyze most frequently asked questions
- Update Space instructions with clarifications
- Add new synonyms to metric views if needed
- Review performance metrics (query time, success rate)
- Conduct user feedback session

### Quarterly Tasks
- Comprehensive usage report (adoption, satisfaction)
- User training session for new team members
- Review and update all benchmark questions
- Optimize slow-performing queries
- Add new business questions as use cases evolve
```

---

## Common Mistakes to Avoid

### ❌ DON'T: Minimal Agent Instructions
```markdown
# BAD: Too brief, no business context
Instructions:
Use sales_metrics for sales questions.
Use inventory_metrics for inventory questions.
```

### ✅ DO: Comprehensive Agent Instructions
```markdown
# GOOD: Rich business context, query patterns, examples
=================================================================================
AGENT INSTRUCTIONS
=================================================================================

BUSINESS DOMAIN KNOWLEDGE:
[200-500 lines of detailed business context]

DATA ASSETS AVAILABLE:
[Detailed asset descriptions with when to use each]

QUERY INTERPRETATION GUIDELINES:
[10 categories of interpretation rules]
```

### ❌ DON'T: Generic Example Questions
```markdown
# BAD: Vague, no expected results
Example Questions:
- Show me sales
- What about inventory?
- Compare stores
```

### ✅ DO: Specific Benchmark Questions
```markdown
# GOOD: Specific, with expected answers and validation
#### Q1.1: Top Stores by Revenue
**Business Question:**
```
What are the top 10 stores by revenue this month?
```

**Expected Answer Format:**
| Rank | Store Number | Store Name | Total Revenue |
|------|--------------|------------|---------------|
| 1 | 150 | Quick Gas #150 | $125,450.00 |

**Validation Criteria:**
✓ Returns exactly 10 stores
✓ Revenue formatted as currency
✓ Sorted descending by revenue
```

### ❌ DON'T: Add Only Tables as Trusted Assets
```markdown
# BAD: No pre-aggregation, poor performance
Trusted Data:
- fact_sales (100M rows)
- fact_inventory (50M rows)
```

### ✅ DO: Add Metric Views First
```markdown
# GOOD: Pre-aggregated, optimized, rich semantics
Trusted Data:
- sales_performance_metrics (metric view, 1M rows, 30+ measures)
- inventory_health_metrics (metric view, 500K rows, 15+ measures)
- get_sales_trend(days_back) (TVF for common pattern)
```

---

## Success Metrics

### KPIs to Track

After deployment, measure:

1. **Adoption Metrics**
   - Number of active users per week
   - Questions asked per day
   - Unique questions (not repeated)

2. **Quality Metrics**
   - Query success rate (target: 90%+)
   - Average response time (target: < 10 sec)
   - User satisfaction rating (target: 4.5/5)

3. **Usage Patterns**
   - Most asked questions (inform future metric views)
   - Most used metric views (validate design)
   - Peak usage times (capacity planning)

4. **Business Impact**
   - Time saved vs traditional dashboards
   - Ad-hoc SQL requests reduction
   - Decisions made faster

---

## Validation Checklist

When creating Genie Space setup guides:

- [ ] Four-section structure followed (Description, Instructions, Assets, Questions)
- [ ] Agent instructions include all 10 critical components
- [ ] Business domain knowledge is comprehensive (200+ lines)
- [ ] KPIs defined with formulas
- [ ] Query interpretation guidelines cover 10 categories
- [ ] Metric views documented with dimensions, measures, examples
- [ ] TVFs documented with parameters, returns, use cases
- [ ] 20-30 benchmark questions created
- [ ] Questions organized by business function
- [ ] Each question has expected answer format and validation criteria
- [ ] Testing plan defined with success criteria
- [ ] User training materials included
- [ ] Deployment checklist comprehensive (30+ items)
- [ ] Maintenance tasks defined (weekly, monthly, quarterly)

---

## References

### Official Databricks Documentation
- [Genie Overview](https://docs.databricks.com/genie/)
- [Create a Genie Space](https://docs.databricks.com/genie/create-space.html)
- [Add Trusted Assets](https://docs.databricks.com/genie/trusted-assets.html)
- [Query with Genie](https://docs.databricks.com/genie/query.html)
- [Metric Views Documentation](https://docs.databricks.com/metric-views/)

### Related Cursor Rules
- [metric-views-patterns.mdc](mdc:.cursor/rules/metric-views-patterns.mdc) - Metric view YAML structure
- [databricks-asset-bundles.mdc](mdc:.cursor/rules/databricks-asset-bundles.mdc) - Asset Bundle deployment

### Project Examples
- [GENIE_SPACE_SETUP_GUIDE.md](../docs/gold/GENIE_SPACE_SETUP_GUIDE.md) - Complete implementation example
- [METRIC_VIEWS_GUIDE.md](../docs/gold/METRIC_VIEWS_GUIDE.md) - Metric views setup

---

## Pattern Improvement Case Study

**Date:** January 2025  
**Rule Created:** genie-space-patterns.mdc  
**Trigger:** Comprehensive Genie Space setup for retail analytics

### Implementation Summary

**Created:**
- Complete Genie Space setup guide (1,800+ lines)
- 27 benchmark questions across 8 business categories
- Comprehensive agent instructions (500+ lines)
- Testing framework with validation criteria

**Results:**
- Production-ready Genie Space configuration
- Reusable patterns for future Genie deployments
- Clear testing and validation approach
- User training materials template

**Reusable Insights:**
- Agent instructions quality is the #1 factor in Genie success
- Business context must be extremely detailed (200-500 lines)
- Benchmark questions with expected answers accelerate testing
- Four-section structure provides clarity and completeness
- Metric views + TVFs hierarchy optimizes performance

**Next Steps:**
- Apply pattern to other Genie Space deployments
- Track success metrics after production launch
- Refine based on user feedback
- Document lessons learned in quarterly review
