# Wanderbricks Alert Deployment Job
#
# Deploys SQL alerts from the alert_rules configuration table.
# Reads enabled rules from Delta and creates/updates Databricks SQL Alerts.
#
# This implements a config-driven alerting pattern where:
# 1. Alert rules are stored in alert_rules Delta table (setup by alert_rules_setup_job)
# 2. This job reads enabled rules and creates/updates SQL alerts via Databricks SDK
# 3. Run this job whenever rules are added/modified in the config table
#
# The new Databricks SQL Alerts (Public Preview) are used, which:
# - Don't support parameters in queries (uses fully qualified table names)
# - Support custom notification templates
# - Have states: TRIGGERED, OK, ERROR
#
# Reference: https://learn.microsoft.com/en-us/azure/databricks/sql/user/alerts/
#
# Usage:
#   # Deploy alerts (creates/updates from config)
#   databricks bundle run alert_deploy_job -t dev
#
#   # Dry run (validate without creating)
#   # Note: Edit the dry_run parameter below or pass via job parameters
#
# Prerequisites:
#   1. Run alert_rules_setup_job first to create alert_rules table
#   2. Ensure Gold layer tables exist (fact_booking_daily, fact_property_engagement, etc.)

resources:
  jobs:
    alert_deploy_job:
      name: "[${bundle.target}] Wanderbricks Alert - Deploy"
      description: "Deploys SQL alerts from alert_rules configuration table"
      
      # Serverless environment with Databricks SDK
      environments:
        - environment_key: default
          spec:
            environment_version: "4"
            dependencies:
              - "databricks-sdk>=0.28.0"
      
      tasks:
        - task_key: deploy_alerts
          environment_key: default
          notebook_task:
            notebook_path: ../../src/wanderbricks_gold/alerting/deploy_alerts.py
            base_parameters:
              catalog: ${var.catalog}
              gold_schema: ${var.gold_schema}
              warehouse_id: ${var.warehouse_id}
              dry_run: "false"  # Set to "true" for validation without creating alerts
          timeout_seconds: 1800  # 30 minutes
      
      # Email notifications
      email_notifications:
        on_failure:
          - prashanth.subrahmanyam@databricks.com
        on_success:
          - prashanth.subrahmanyam@databricks.com
      
      # Tags
      tags:
        environment: ${bundle.target}
        project: wanderbricks
        layer: gold
        job_type: deployment
        component: alerting
        compute_type: serverless




