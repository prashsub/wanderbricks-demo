# Wanderbricks Alert Rules Setup Job
#
# Creates the alert_rules configuration table in Gold layer and populates
# with all 21 alert rules for the Wanderbricks platform.
#
# This is a one-time setup job that should be run:
# 1. When deploying alerting framework for the first time
# 2. When adding new alert rules to the configuration
# 3. When modifying existing alert rule configurations
#
# The alert_rules table is the single source of truth for all SQL alert
# configurations, enabling config-driven alerting without code changes.
#
# Usage:
#   databricks bundle run alert_rules_setup_job -t dev
#
# After running this job:
#   1. Review rules: SELECT * FROM {catalog}.{gold_schema}.alert_rules
#   2. Run alert_deploy_job to create actual SQL alerts

resources:
  jobs:
    alert_rules_setup_job:
      name: "[${bundle.target}] Wanderbricks Alert Rules - Setup"
      description: "Creates alert_rules configuration table with all 21 alert rule definitions"
      
      # Serverless environment
      environments:
        - environment_key: default
          spec:
            environment_version: "4"
      
      tasks:
        - task_key: setup_alert_rules
          environment_key: default
          notebook_task:
            notebook_path: ../../src/wanderbricks_gold/alerting/setup_alert_rules.py
            base_parameters:
              catalog: ${var.catalog}
              gold_schema: ${var.gold_schema}
          timeout_seconds: 1800  # 30 minutes
      
      # Email notifications
      email_notifications:
        on_failure:
          - prashanth.subrahmanyam@databricks.com
        on_success:
          - prashanth.subrahmanyam@databricks.com
      
      # Tags
      tags:
        environment: ${bundle.target}
        project: wanderbricks
        layer: gold
        job_type: setup
        component: alerting
        compute_type: serverless




