# Table metadata
table_name: alert_rules
domain: alerting
bronze_source: N/A (config table)

# Table description
description: >
  Gold layer configuration table storing all alert rule definitions for the Wanderbricks platform.
  Business: Central repository for alert configurations enabling config-driven alerting. Alert rules define 
  monitoring conditions, thresholds, and notification settings for revenue, engagement, property, host, and 
  customer domains. Used by alert deployment jobs to create/update Databricks SQL Alerts dynamically.
  Technical: Config table pattern - no source data, populated via setup scripts. Each row defines one alert
  including its SQL query, condition, schedule, and notification recipients. Supports alert lifecycle management
  (enable/disable/update) without code changes.

# Grain definition
grain: "One row per alert rule"

# Primary key definition
primary_key:
  columns: ['alert_id']
  composite: false

# Column definitions
columns:
  # Primary Key
  - name: alert_id
    type: STRING
    nullable: false
    description: >
      Unique identifier for the alert rule.
      Business: Alert ID using convention DOMAIN-NUMBER-SEVERITY (e.g., REV-001-CRIT, ENG-003-WARN).
      Enables filtering alerts by domain and severity.
      Technical: Primary key, format validated during insert. Used to identify alerts for update/delete operations.

  - name: alert_name
    type: STRING
    nullable: false
    description: >
      Human-readable display name for the alert.
      Business: Descriptive name shown in Databricks UI and notifications. Should clearly convey what the alert monitors.
      Technical: Used as alert display name in Databricks SQL Alerts.

  - name: domain
    type: STRING
    nullable: false
    description: >
      Business domain this alert belongs to.
      Business: Categorization for filtering and routing. Valid values: revenue, engagement, property, host, customer.
      Technical: Used for filtering alerts by domain, maps to notification channels.

  - name: severity
    type: STRING
    nullable: false
    description: >
      Alert severity level.
      Business: Determines escalation path and notification urgency. CRITICAL=immediate action, WARNING=investigate, INFO=summary.
      Technical: Valid values: CRITICAL, WARNING, INFO. Used for notification routing and display formatting.

  - name: alert_description
    type: STRING
    nullable: false
    description: >
      Detailed description of what this alert monitors and why.
      Business: Context for alert recipients to understand issue impact and potential actions.
      Technical: Included in alert notifications and documentation.

  - name: alert_query
    type: STRING
    nullable: false
    description: >
      SQL query that returns alert data when condition is met.
      Business: The monitoring query that checks for threshold violations or anomalies.
      Technical: Must return rows when alert should trigger. Uses fully qualified table names with catalog.schema.table pattern.
      Query should include alert_message column for custom notification content.

  - name: condition_column
    type: STRING
    nullable: false
    description: >
      Column name to evaluate in alert condition.
      Business: The metric or value being monitored (e.g., pct_change, cancellation_rate).
      Technical: Column from alert_query result used in condition evaluation.

  - name: condition_operator
    type: STRING
    nullable: false
    description: >
      Comparison operator for condition evaluation.
      Business: How the monitored value is compared to threshold.
      Technical: Valid values: >, <, >=, <=, =, !=. Applied to condition_column value.

  - name: condition_threshold
    type: STRING
    nullable: false
    description: >
      Threshold value for condition comparison.
      Business: The boundary value that triggers the alert when crossed.
      Technical: Stored as STRING to support various data types. Cast to appropriate type during evaluation.

  - name: aggregation_type
    type: STRING
    nullable: true
    description: >
      Optional aggregation to apply before condition check.
      Business: Enables checking aggregated values like SUM, AVG, COUNT across result rows.
      Technical: Valid values: SUM, AVG, COUNT, MIN, MAX, FIRST, or NULL for no aggregation.

  - name: schedule_cron
    type: STRING
    nullable: false
    description: >
      Quartz cron expression defining alert evaluation schedule.
      Business: How frequently the alert condition is checked.
      Technical: Quartz cron format (e.g., "0 0 6 * * ?" for daily at 6 AM). Timezone specified separately.

  - name: schedule_timezone
    type: STRING
    nullable: false
    description: >
      Timezone for schedule evaluation.
      Business: Ensures alerts fire at appropriate business hours.
      Technical: IANA timezone identifier (e.g., "America/Los_Angeles", "UTC").

  - name: notification_emails
    type: STRING
    nullable: true
    description: >
      Comma-separated list of email addresses for notifications.
      Business: Alert recipients who should be notified when alert triggers.
      Technical: Parsed as array for notification destination setup. NULL means no email notification.

  - name: notification_slack_channel
    type: STRING
    nullable: true
    description: >
      Slack channel ID or name for notifications.
      Business: Team channel for collaborative alert response.
      Technical: Requires pre-configured Slack notification destination. NULL means no Slack notification.

  - name: custom_subject_template
    type: STRING
    nullable: true
    description: >
      Custom email subject template using alert variables.
      Business: Contextual subject line for email notifications.
      Technical: Supports variables: {{ALERT_NAME}}, {{ALERT_STATUS}}, {{ALERT_TIME}}.

  - name: custom_body_template
    type: STRING
    nullable: true
    description: >
      Custom notification body template with alert context.
      Business: Detailed notification message with metrics and context.
      Technical: Supports variables: {{ALERT_NAME}}, {{ALERT_STATUS}}, {{ALERT_TIME}}, 
      {{QUERY_RESULT_VALUE}}, {{QUERY_RESULT_TABLE}}, {{ALERT_URL}}.

  - name: notify_on_ok
    type: BOOLEAN
    nullable: false
    description: >
      Whether to send notification when alert returns to OK status.
      Business: Enable recovery notifications for critical alerts.
      Technical: Default false. When true, sends notification when condition no longer met.

  - name: rearm_seconds
    type: INT
    nullable: true
    description: >
      Seconds to wait before re-triggering alert (cooldown period).
      Business: Prevents alert fatigue from repeated notifications.
      Technical: NULL means no cooldown. Typical values: 1800 (30 min), 3600 (1 hour).

  - name: is_enabled
    type: BOOLEAN
    nullable: false
    description: >
      Whether this alert rule is active.
      Business: Enable/disable alerts without deleting configuration.
      Technical: Disabled alerts are skipped during deployment. Use for maintenance or decommissioning.

  - name: tags
    type: STRING
    nullable: true
    description: >
      JSON-formatted tags for alert categorization.
      Business: Additional metadata for filtering and organization.
      Technical: JSON object string (e.g., '{"team": "revenue", "priority": "p1"}').

  - name: owner
    type: STRING
    nullable: false
    description: >
      Email of the alert owner/maintainer.
      Business: Point of contact for alert rule changes and escalations.
      Technical: Used for alert ownership in Databricks SQL Alerts.

  # Audit Columns
  - name: record_created_timestamp
    type: TIMESTAMP
    nullable: false
    description: >
      Timestamp when this alert rule was first created.
      Business: Audit field for tracking when alert was added.
      Technical: Set once at INSERT time, never updated.

  - name: record_updated_timestamp
    type: TIMESTAMP
    nullable: false
    description: >
      Timestamp when this alert rule was last modified.
      Business: Audit field for tracking configuration changes.
      Technical: Updated on every configuration change.

# Table properties
table_properties:
  contains_pii: false
  data_classification: internal
  business_owner: Data Engineering
  technical_owner: Data Engineering
  update_frequency: On-demand
  config_table: true




